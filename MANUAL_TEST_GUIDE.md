# Manual Testing Guide - Cancellation Handling

**æ¸¬è©¦æ—¥æœŸï¼š** 2025-10-01
**æ¸¬è©¦ç‰ˆæœ¬ï¼š** v1.1 (å«å–æ¶ˆè™•ç†)

---

## ğŸ“‹ æ¸¬è©¦æª¢æŸ¥æ¸…å–®

### æƒ…å¢ƒ 1ï¼šç”¨æˆ¶åœ¨ PayPal é é¢é»æ“Šå–æ¶ˆ âœ…

**æ¸¬è©¦æ­¥é©Ÿï¼š**
1. é–‹å•Ÿ `http://localhost:8502`
2. è¨­å®šé‡‘é¡ $10.00 USD
3. é»æ“Šã€ŒPay $10.00 USDã€æŒ‰éˆ•
4. PayPal popup é–‹å•Ÿå¾Œï¼Œé»æ“Šã€ŒCancel and return to...ã€é€£çµ
5. è§€å¯Ÿçµæœ

**é æœŸè¡Œç‚ºï¼š**
- âœ… Popup è‡ªå‹•é—œé–‰
- âœ… é¡¯ç¤ºè¨Šæ¯ï¼šã€Œâš ï¸ You cancelled the payment on PayPalã€
- âœ… é¡¯ç¤ºã€ŒğŸ”„ Retry Paymentã€æŒ‰éˆ•
- âœ… Backend æ¸…ç† `st.session_state.paypal_pending_orders`
- âœ… è¨˜éŒ„åˆ° `st.session_state.cancelled_payments`ï¼ˆreason: `user_cancelled`ï¼‰

**å¯¦éš›çµæœï¼š**
[x] é€šé

**å‚™è¨»ï¼š**
- 2025-10-02: ç”¨æˆ¶æ¸¬è©¦é€šé âœ…
- PayPal é é¢å–æ¶ˆæŒ‰éˆ•æ­£å¸¸é‹ä½œ
- è¨Šæ¯æ­£ç¢ºé¡¯ç¤º


---

### æƒ…å¢ƒ 2ï¼šç”¨æˆ¶æ‰‹å‹•é—œé–‰ Popup âœ…

**æ¸¬è©¦æ­¥é©Ÿï¼š**
1. é–‹å•Ÿ `http://localhost:8502`
2. è¨­å®šé‡‘é¡ $10.00 USD
3. é»æ“Šã€ŒPay $10.00 USDã€æŒ‰éˆ•
4. PayPal popup é–‹å•Ÿå¾Œï¼Œç›´æ¥é—œé–‰è¦–çª—ï¼ˆé» X æˆ–æŒ‰ ESCï¼‰
5. è§€å¯Ÿçµæœ

**é æœŸè¡Œç‚ºï¼š**
- âœ… Streamlit æª¢æ¸¬åˆ° popup é—œé–‰
- âœ… é¡¯ç¤ºè¨Šæ¯ï¼šã€Œâš ï¸ Payment window was closedã€
- âœ… é¡¯ç¤ºã€ŒğŸ”„ Retry Paymentã€æŒ‰éˆ•
- âœ… Backend æ¸…ç† pending order
- âœ… è¨˜éŒ„åˆ° cancelled_paymentsï¼ˆreason: `user_closed`ï¼‰

**å¯¦éš›çµæœï¼š**
[x] é€šé

**å‚™è¨»ï¼š**
- 2025-10-02: ç”¨æˆ¶æ¸¬è©¦é€šé âœ…
- Popup é—œé–‰æª¢æ¸¬æ­£å¸¸
- è¨Šæ¯æ­£ç¢ºé¡¯ç¤º
- **Bug ä¿®å¾©ï¼š** Retry æŒ‰éˆ•ç¾åœ¨æœƒæ¸…é™¤å–æ¶ˆç‹€æ…‹


---

### æƒ…å¢ƒ 3ï¼šä»˜æ¬¾è¶…æ™‚ï¼ˆ5 åˆ†é˜ï¼‰ â±

**æ¸¬è©¦æ­¥é©Ÿï¼š**
1. é–‹å•Ÿ `http://localhost:8502`
2. è¨­å®šé‡‘é¡ $10.00 USD
3. é»æ“Šã€ŒPay $10.00 USDã€æŒ‰éˆ•
4. PayPal popup é–‹å•Ÿå¾Œï¼Œ**ä¸åšä»»ä½•æ“ä½œ**
5. ç­‰å¾… 5 åˆ†é˜
6. è§€å¯Ÿçµæœ

**é æœŸè¡Œç‚ºï¼š**
- âœ… 5 åˆ†é˜å¾Œ popup è‡ªå‹•é—œé–‰
- âœ… é¡¯ç¤ºè¨Šæ¯ï¼šã€Œâš ï¸ Payment timed out (exceeded 5 minutes)ã€
- âœ… é¡¯ç¤ºã€ŒğŸ”„ Retry Paymentã€æŒ‰éˆ•
- âœ… Backend æ¸…ç† pending order
- âœ… è¨˜éŒ„åˆ° cancelled_paymentsï¼ˆreason: `timeout`ï¼‰

**å¯¦éš›çµæœï¼š**
[x] é€šé

**å‚™è¨»ï¼š**
- 2025-10-02: ç”¨æˆ¶æ¸¬è©¦é€šé âœ…
- 5 åˆ†é˜è¶…æ™‚æ©Ÿåˆ¶æ­£å¸¸é‹ä½œ
- Popup è‡ªå‹•é—œé–‰
- è¨Šæ¯æ­£ç¢ºé¡¯ç¤º


---

### æƒ…å¢ƒ 4ï¼šæˆåŠŸä»˜æ¬¾ï¼ˆé©—è­‰æœªå—å½±éŸ¿ï¼‰ âœ…

**æ¸¬è©¦æ­¥é©Ÿï¼š**
1. é–‹å•Ÿ `http://localhost:8502`
2. è¨­å®šé‡‘é¡ $10.00 USD
3. é»æ“Šã€ŒPay $10.00 USDã€æŒ‰éˆ•
4. åœ¨ PayPal é é¢å®Œæˆä»˜æ¬¾
5. è§€å¯Ÿçµæœ

**é æœŸè¡Œç‚ºï¼š**
- âœ… ä»˜æ¬¾æˆåŠŸ
- âœ… é¡¯ç¤ºã€ŒğŸ‰ Payment Successful!ã€
- âœ… é¡¯ç¤ºè¨‚å–®è³‡è¨Šï¼ˆOrder ID, Status, Payer, Amountï¼‰
- âœ… **ä¸é¡¯ç¤ºå–æ¶ˆè¨Šæ¯**
- âœ… Backend æ­£å¸¸æ•ç²è¨‚å–®ä¸¦æ¸…ç† pending order

**å¯¦éš›çµæœï¼š**
[x] é€šé

**å‚™è¨»ï¼š**
- 2025-10-02: ç”¨æˆ¶æ¸¬è©¦é€šé âœ…
- è¨‚å–® ID: 69Y8080736191525L
- ç‹€æ…‹: COMPLETED
- é‡‘é¡: $10.00 USD
- æ‰‹çºŒè²»: $0.84
- å¯¦æ”¶: $9.16
- å–æ¶ˆè™•ç†åŠŸèƒ½ä¸å½±éŸ¿æ­£å¸¸ä»˜æ¬¾æµç¨‹


---

## ğŸ” æª¢æŸ¥é …ç›®

### Backend ç‹€æ…‹æª¢æŸ¥

**æª¢æŸ¥ `st.session_state.paypal_pending_orders`ï¼š**
```python
# åœ¨ Streamlit app ä¸­æ·»åŠ è‡¨æ™‚ debug
with st.expander("ğŸ” Debug: Pending Orders"):
    st.json(st.session_state.get('paypal_pending_orders', {}))
```

**é æœŸï¼š**
- å–æ¶ˆå¾Œæ‡‰ç‚ºç©º `{}`
- ä»˜æ¬¾æˆåŠŸå¾Œæ‡‰ç‚ºç©º `{}`

---

### Frontend æ§åˆ¶å°æª¢æŸ¥

**é–‹å•Ÿç€è¦½å™¨é–‹ç™¼è€…å·¥å…·ï¼ˆF12ï¼‰**

**æª¢æŸ¥é …ç›®ï¼š**
1. é»æ“Šä»˜æ¬¾æŒ‰éˆ•æ™‚ï¼Œconsole æ‡‰é¡¯ç¤ºï¼š
   ```
   authorization_url: https://www.sandbox.paypal.com/checkoutnow?token=XXX
   ```

2. å–æ¶ˆæ™‚ï¼Œcomponent æ‡‰è¿”å›ï¼š
   ```javascript
   {cancelled: true, reason: "user_cancelled", token: "XXX"}
   ```

3. æˆåŠŸä»˜æ¬¾æ™‚ï¼Œcomponent æ‡‰è¿”å›ï¼š
   ```javascript
   {token: "XXX", PayerID: "YYY"}
   ```

---

## ğŸ“Š æ¸¬è©¦çµæœçµ±è¨ˆ

| æƒ…å¢ƒ | ç‹€æ…‹ | åŸå› æª¢æ¸¬ | UI åé¥‹ | State æ¸…ç† | Retry åŠŸèƒ½ |
|------|------|---------|---------|-----------|-----------|
| 1. PayPal å–æ¶ˆ | âœ… | âœ… | âœ… | âœ… | âœ… |
| 2. æ‰‹å‹•é—œé–‰ | âœ… | âœ… | âœ… | âœ… | âœ… |
| 3. è¶…æ™‚ | âœ… | âœ… | âœ… | âœ… | âœ… |
| 4. æˆåŠŸä»˜æ¬¾ | âœ… | N/A | âœ… | âœ… | N/A |

---

## ğŸ› å·²çŸ¥å•é¡Œ

### å•é¡Œ 1: Retry æŒ‰éˆ•æœªæ¸…é™¤å–æ¶ˆç‹€æ…‹ âŒ â†’ âœ… å·²ä¿®å¾©

**ç™¼ç¾æ—¥æœŸï¼š** 2025-10-02
**ç‹€æ…‹ï¼š** âœ… å·²ä¿®å¾©

**å•é¡Œæè¿°ï¼š**
- é»æ“Š Retry Payment æŒ‰éˆ•å¾Œï¼Œå–æ¶ˆè¨Šæ¯ä»ç„¶é¡¯ç¤º
- åŸå› ï¼šcomponent çš„ result è¢«å¿«å–ï¼Œæœªæ­£ç¢ºæ¸…é™¤ç‹€æ…‹

**ä¿®å¾©æ–¹å¼ï¼š**
- å°‡å–æ¶ˆçµæœå­˜å…¥ `st.session_state.last_cancellation`
- Retry æŒ‰éˆ•é»æ“Šæ™‚åˆªé™¤ `last_cancellation` ä¸¦ rerun
- åªåœ¨ç„¡ pending cancellation æ™‚é¡¯ç¤ºä»˜æ¬¾æŒ‰éˆ•

**æäº¤ï¼š** commit å¾…æäº¤

---

## âœ… æ¸¬è©¦ç°½æ ¸

**æ¸¬è©¦äººå“¡ï¼š** ç”¨æˆ¶ï¼ˆlvdeenï¼‰
**æ¸¬è©¦æ—¥æœŸï¼š** 2025-10-02
**æ¸¬è©¦çµæœï¼š** [x] å…¨éƒ¨é€šé
**å‚™è¨»ï¼š**
- æ‰€æœ‰ 4 å€‹æƒ…å¢ƒæ¸¬è©¦é€šé
- ç™¼ç¾ä¸¦ä¿®å¾© Retry æŒ‰éˆ• bug
- åŠŸèƒ½å®Œæ•´ä¸”ç©©å®š
